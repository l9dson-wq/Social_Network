@* Vista parcial que me ayudara a mostrar los comentaios *@

@using Core.Application.ViewModels.Partial
@model CommentPartialViewModel
@using Microsoft.AspNetCore.Http;
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using Core.Application
@using Core.Domain
@inject IHttpContextAccessor iHttpContext;
@{
  var userSession = iHttpContext?.HttpContext?.Session.Get<UserProfileViewModel>("userProfile");
}

@if (Model.Comments != null && Model.Comment != null)
{
  foreach (var comment in Model.Comments)
  {
    if (comment.Id == Model.Comment.Id)
    {
      <div class="w-full flex flex-row px-2">

        <!-- PFP -->
        <div class="w-fit mr-1 flex flex-col items-center justify-between">
          <img src="~/@Model.UserProfile.ProfilePicturePath" alt=""
               class="w-7 h-7 object-cover rounded-full my-1"/>
          <div class="w-1 h-5 border-l border-gray-300"></div>
          <i class="@(comment.Replies.Any() ? "ri-add-circle-line hover:cursor-pointer showMore" : "hidden")"></i>
          <div class="w-1 h-full border-l border-gray-300"></div>
        </div>

        @* lo que puedo hacer para controlar los comentarios es saber cuantos hay incluso en los replies (si es posible)*@
        @* Darle una clase al div de abajo y crear un boton mas arriba que me permita ocultar el div inferior y mostrarlo*@
        
        <!-- COMMENTS AND REPLIES -->
        <div class="w-full flex flex-col commentReplies">
          <!-- COMMENT -->
          <div class="w-full">
            <!-- USERNAMNE AND TIME AGO-->
            <div class="flex flex-row justify-start items-center py-1">
              <div class="flex">
                <p class="text-xs font-semibold hover:cursor-pointer hover:underline underline-offset-4">
                  U/@Model.UserProfile.UserName
                </p>
                <span class="text-xs text-gray-600">. 6 min. ago</span>
                <span class="text-xs text-gray-600"> - Replied to @comment.ParentComment?.Id</span>
              </div>
            </div>
            <!-- DESCRIPTION -->
            <div class="px-2">
              <p class="text-sm text-slate-900 w-fit descriptionText">
                @comment.Description
              </p>
            </div>
            <!-- LIKES, RESPONDS, ETC -->
            <div class="flex flex-row mt-1">
              <!-- likes and dislike -->
              <!-- REPLY -->
              <button href="#" class="flex flex-row items-center rounded-full w-fit ml-1 replyButton">
                <span class="p-1 text-slate-700 text-sm">
                  <i class="ri-message-2-line"></i>
                  @(comment.Replies != null ? comment.Replies.Count : "0")
                  Reply
                </span>
              </button>
              <!-- Share button -->
              <a href="#" class="flex flex-row items-center rounded-full w-fit ml-1">
                <span class="p-1">
                  <p class="text-slate-700 text-sm">Share</p>
                </span>
              </a>
            </div>

            <!-- FORM TO SEND A REPLY -->
            <form method="post" class="hidden replyForm" asp-controller="Comment" asp-action="AddReply" asp-route-commentId="@Model.Comment.Id">
              <div class="mt-5 border rounded-sm">
                <input type="hidden" asp-for="@Model.SaveComment.UserId" value="@userSession?.Id">
                <textarea asp-for="@Model.ReplyDescription" rows="4" class="!outline-none border-b w-full resize-none p-2 text-sm overflow-y-scroll scrollbar-thin scrollbar-thumb-gray-500 scrollbar-track-gray-300"></textarea>
                <div class="w-full flex justify-end items-center p-1">
                  <button type="button" class="px-2 text-blue-700 text-sm mr-2 cancelReplyButton">Cancel</button>
                  <button type="submit" class="text-white py-1 px-4 bg-blue-700 rounded-full text-sm">Comment</button>
                </div>
              </div>
            </form>
            <!-- FORM TO SEND A REPLY -->

          </div>

          <!-- Check if there are replies to this comment -->
          @if (comment.Replies != null && comment.Replies.Any())
          {
            <div class="replies-container hidden bg-green-100">
              @foreach (var reply in comment?.Replies)
              {
                var replyPartialModel = new CommentPartialViewModel
                {
                  Comment = reply,
                  UserProfile = Model.UserProfile,
                  Comments = Model.Comments,
                };

                @await Html.PartialAsync("_CommentPartial", replyPartialModel)
              }
            </div>
          }
        </div>
        
      </div>
    }
  }
}

<script>
  // Verifica si el script ya se ha ejecutado antes
  if (!window.showMoreScriptExecuted) {
    // Evita que el script se ejecute nuevamente
    window.showMoreScriptExecuted = true;

    // Asigna el evento click al contenedor principal
    document.addEventListener("click", function (event) {
      // Verifica si se hizo clic en un botón showMore
      if (event.target.classList.contains("showMore")) {
        // Encuentra el contenedor de respuestas correspondiente
        let currentCommentReplies = event.target.closest('.w-full').querySelector('.replies-container');

        // Alterna la visibilidad del contenedor
        if (currentCommentReplies) {
          currentCommentReplies.classList.toggle("hidden");
          event.target.classList.toggle("ri-indeterminate-circle-line");
        }
      }
    });

    let numberOfReplies = document.querySelectorAll(".replies-container").length;
    console.log("Número de respuestas:", numberOfReplies);
  }
</script>
